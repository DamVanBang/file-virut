'use strict';

const path = require('path');
const fs = require('fs');
const util = require('./util');

class Packageble {
  constructor(dir) {
    this.dir = dir;
    this.pack = this.readPackage();
    this.name = this.pack.name;
  }

  increment() {
    let version = this.pack.version.split('.');
    version[2] = +version[2] + 1;
    this.pack.version = `${version[0]}.${version[1]}.${version[2]}`;
    this.writePackage();
    return version.join('.');
  }

  async publish() {
    return await util.exec(`npm publish .`, this.dir);
  }

  readPackage() {
    let filename = path.resolve(this.dir, 'package.json'),
      source = fs.readFileSync(filename, 'utf-8'),
      pack = JSON.parse(source);
    this.pack = pack;
    return this.pack;
  }

  writePackage() {
    try {
      let filename = path.resolve(this.dir, 'package.json'),
        source = JSON.stringify(this.pack, null, 2);
      fs.writeFileSync(filename, source);
    } catch (err) {}
  }
}

module.exports = Packageble;
